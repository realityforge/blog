---
layout: post
title: Documenting Cookbooks
---

<p>
    Our infrastructure has many cookbooks that aim to be
    <a href="/code/2012/05/12/evolving-towards-cookbook-reusability-in-chef.html">
        reusable</a>, primarily through encapsulating behaviour in LWRPs. This led to an
    explosion of LWRPs and sometimes the documentation didn't keep up or did just not
    exist.
</p>

<p>
    Chef has been evolving rapidly and many of the pain points are being
    addressed by Opscode or by the community at large - which is great. However, one
    pain point that is not getting easier is writing cookbook documentation. Several
    threads came together last week to motivate me to change this.
</p>

<ul>
    <li>
        Incorrect documentation of LWRPs contributed to an outage.
    </li>
    <li>
        Mathias Lafeldt wrote a knife <a href="https://github.com/mlafeldt/knife-cookbook-readme">
        plugin</a> that generates an initial <code>README.md</code> from the
        <code>metadata.rb</code> file in a a cookbook.
    </li>
    <li>
        Other languages/frameworks have tools to generate documentation from annotated source code.
    </li>
</ul>

<p>
    So I decided to try and extend Mathias's work so that I could always regenerate
    <code>README.md</code> from the cookbook source code. This result in the
    <a href="https://github.com/realityforge/knife-cookbook-doc">knife-cookbook-doc</a> project.
</p>

<h2>knife cookbook doc DIR</h2>

<p>
    As much as possible the plugin makes use of the same metadata as used by chef
    when generating the documentation. The plugin will also scan the source files
    for annotations present in comments. Users can also add fragments of markdown
    into the <code>doc/</code> directory to merge into the generated <code>README.md</code> file.
</p>

<p>
    The goal is to keep the code as the authoritative source of information. The
    hope is that keeping the documentation close to the code will help to maintain
    it's currency.
</p>

<h3>Getting Started</h3>

<h4>Step 1</h4>

<p>
    Populate the <code>metadata.rb</code> of your cookbook according to Opscode's
    <a href="http://docs.opscode.com/config_rb_metadata.html">documentation</a>. Particular
    attention should be paid to documenting the recipes, attributes, platform
    compatibility and cookbook requirements (i.e. depends, recommends, suggests etc).
</p>

<h4>Step 2</h4>

<p>
    At the top of each recipe, add a detailed documentation section such as;
</p>

{% highlight ruby %}
=begin
#<
The recipe is awesome. It does thing 1, thing 2 and thing 3!
#>
=end
{% endhighlight %}

<h4>Step 3</h4>

<p>
    In each LWRP, add detailed documentation such as;
</p>

{% highlight ruby %}
=begin
#<
This creates and destroy the awesome service.

@action create  Create the awesome service.
@action destroy Destroy the awesome service.

@section Examples

# An example of my awesome service
mycookbook_awesome_service "my_service" do
port 80
end
#>
=end

...

#<> @attribute port The port on which the HTTP service will bind.
attribute :port, :kind_of => Integer, :default => 8080
{% endhighlight %}

<p>
    It should be noted that the documentation of the LWRP requires that the user
    document the actions, using <code>@action &lt;action&gt; &lt;description&gt;</code> and the attributes
    using <code>@attribute &lt;attribute&gt; &lt;description&gt;</code>. This allows meaningful
descriptions for the actions and attributes to be added to the README.
</p>

<p>
    The other text will be added at the start of the LWRP documentation
    except if marked with <code>@section &lt;heading&gt;</code>, in which case it will be added
    to the end of the LWRP documentation.
</p>

<h4>Step 4</h4>

<p>
    Finally the user should add some documentation fragments into the <code>doc/</code> dir.
    Most importantly you should add <code>doc/overview.md</code> which will replace the first
    <code>Description</code> section of the readme. You should also add a <code>doc/credit.md</code> which
    will replace the last <code>License and Maintainer</code> section in the readme. The
    remaining fragments will be included at the end of the readme in lexicographic
    order of the filename.
</p>

<h4>Step 5</h4>

<p>
    Install the plugin and run the knife command, passing the directory of the cookbook as an argument.
</p>

{% highlight sh %}
gem install knife-cookbook-doc
knife cookbook doc MY_COOKBOOK_DIR
{% endhighlight %}

<h3>Examples</h3>

<p>
    For an example of a README generated by the plugin, check out the glassfish
    <a href="https://github.com/realityforge/chef-glassfish">cookbook</a>. Unfortunately the plugin highlights the
    fact that so much of the cookbook is poorly documented. However there are some LWRPs such as
    <a href="https://github.com/realityforge/chef-glassfish#glassfish_mq">glassfish_mq</a> that have the
    beginning of useful documentation.
</p>

<h2>Final Thoughts</h2>

<p>
    The plugin is raw but usable now. It needs to evolve to be a more seem-less part of our workflow.
    It would also be nice to see it or something more complete be adopted by the rest of chef community.
    I wonder what needs to be done to build such a tool?
</p>

<h2>References</h2>

<ul>
    <li><a href="https://github.com/realityforge/knife-cookbook-doc">knife-cookbook-doc</a> - the new plugin.</li>
    <li><a href="https://github.com/mlafeldt/knife-cookbook-readme">knife-cookbook-readme</a> - the original plugin.</li>
    <li><a href="https://github.com/realityforge/chef-glassfish">chef-glassfish</a> - example cookbook using the new plugin.</li>
</ul>

<h2>Updates: 3rd of April, 2013 </h2>

<p>
    A References section was added, as well as the notes about the credit section.
</p>
